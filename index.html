<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Zone Map - Conquête Géométrique</title>
  <!-- CARTOGRAPHIE -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- BASE DE DONNEES (Lien stable 2025) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="cdn.jsdelivr.net"></script>
    <script src="unpkg.com"></script>

    <style>
        html, body { height: 100%; margin: 0; background: #1a1a1a; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        .hero-header {
            background: url('ZoneMapAccueil.png') no-repeat center center; background-size: cover;
            padding: 30px; border-radius: 20px; text-align: center; color: white;
            box-shadow: inset 0 0 50px #000; border: 1px solid #333; margin-bottom: 20px;
        }

        #auth-screen {
            position: fixed; z-index: 2000; width: 100%; height: 100%;
            background: #0f0f0f; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .score-panel {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(0,0,0,0.85); color: white; padding: 15px; border-radius: 10px;
            border-left: 5px solid #007aff; display: none; min-width: 150px;
        }

        .auth-container { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px); width: 280px; }
        input { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: none; box-sizing: border-box; }
        button { width: 100%; padding: 10px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="hero-header">
        <h1>ZONE MAP</h1>
        <p>Tracez pour capturer</p>
    </div>
    <div class="auth-container">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Mot de passe">
        <button style="background:#007aff; color:white;" onclick="connexion()">ENTRER</button>
    </div>
</div>

<div class="score-panel" id="ui-jeu">
    <div style="font-size:0.7rem; opacity:0.6; text-transform:uppercase;">Surface Capturée</div>
    <div id="surface-val" style="font-size:1.4rem; font-weight:bold; color:#007aff;">0 m²</div>
    <div id="pseudo-display" style="font-size:0.8rem; margin-top:5px;">Joueur: ...</div>
</div>

<div id="map"></div>

<script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://unwzavmahixfwyplhcxw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVud3phdm1haGl4Znd5cGxoY3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NjA0NzYsImV4cCI6MjA4MjEzNjQ3Nn0.I4YtMgaIKt17UGr3EfGf0L186GQSlv2puF_EzabP1B0';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let map, polyline, currentUser;
    let trajetCoords = []; // Liste de [lng, lat] pour Turf
    let zonesPolygones = []; // Stockage des zones fermées
    const LARGEUR_TRAJET = 4; // Largeur en mètres

    window.onload = () => {
        map = L.map('map', { zoomControl: false }).setView([46, 2], 6);
        L.tileLayer('https://{s}{z}/{x}/{y}{r}.png').addTo(map);
        
        // Style du ruban de marche
        polyline = L.polyline([], {
            color: '#007aff', 
            weight: 12, // Équivalent visuel à ~4m à haut zoom
            opacity: 0.6,
            lineCap: 'round'
        }).addTo(map);

        verifierSession();
    };

    async function verifierSession() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) demarrerJeu(session.user);
    }

    async function connexion() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
        if (!error) demarrerJeu(data.user);
    }

    function demarrerJeu(user) {
        currentUser = user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('ui-jeu').style.display = 'block';
        document.getElementById('pseudo-display').innerText = user.email;

        map.locate({ watch: true, enableHighAccuracy: true });
        map.on('locationfound', gererDeplacement);
    }

    function gererDeplacement(e) {
        const p = [e.latlng.lng, e.latlng.lat];
        
        // Éviter les points en doublon
        if (trajetCoords.length > 0) {
            const last = trajetCoords[trajetCoords.length - 1];
            if (p[0] === last[0] && p[1] === last[1]) return;
        }

        trajetCoords.push(p);
        
        // Mise à jour de la ligne visuelle (Leaflet utilise lat,lng)
        polyline.addLatLng(e.latlng);
        map.setView(e.latlng, 18);

        verifierIntersection();
        calculerSurfaceTotale();
    }

    function verifierIntersection() {
        if (trajetCoords.length < 4) return;

        // Créer une ligne avec Turf
        const line = turf.lineString(trajetCoords);
        const kinks = turf.lineIntersect(line, line); // Trouve où la ligne se croise

        if (kinks.features.length > 0) {
            // Une intersection a été trouvée !
            // On transforme le trajet actuel en polygone
            try {
                const polygon = turf.lineToPolygon(line);
                if (polygon) {
                    L.geoJSON(polygon, {
                        style: { color: '#007aff', fillColor: '#007aff', fillOpacity: 0.3, weight: 1 }
                    }).addTo(map);
                    
                    zonesPolygones.push(polygon);
                    // On vide le trajet actuel pour recommencer une nouvelle boucle
                    trajetCoords = [trajetCoords[trajetCoords.length - 1]]; 
                    polyline.setLatLngs([]);
                }
            } catch (err) {
                // Erreur si le polygone est invalide (trop petit ou complexe)
            }
        }
    }

    function calculerSurfaceTotale() {
        let surfaceM2 = 0;

        // 1. Surface du ruban (longueur trajet * 4m)
        if (trajetCoords.length > 1) {
            const line = turf.lineString(trajetCoords);
            const lengthKm = turf.length(line, {units: 'kilometers'});
            surfaceM2 += (lengthKm * 1000) * LARGEUR_TRAJET;
        }

        // 2. Surface des zones fermées
        zonesPolygones.forEach(poly => {
            surfaceM2 += turf.area(poly);
        });

        document.getElementById('surface-val').innerText = Math.round(surfaceM2) + " m²";
    }
</script>
</body>
</html>
