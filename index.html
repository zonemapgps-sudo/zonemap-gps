<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Mon Traceur GPS Live</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <!-- CORRECTION DES LIENS LEAFLET -->
    <link rel="stylesheet" href="unpkg.com" />
    <script src="unpkg.com"></script>

    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .controls {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px; font-family: sans-serif;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .status { color: green; font-weight: bold; }
    </style>
</head>
<body>

<div class="controls">
    <b>Traçage en direct</b><br>
    Statut: <span id="status" class="status">Recherche GPS...</span><br>
    Points: <span id="count">0</span>
</div>
<div id="map"></div>

<script>
    let routeData = [];
    
    // 1. Initialisation de la carte sur la France par défaut
    const map = L.map('map').setView([46.6033, 1.8883], 6);

    // 2. Fond de carte OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    // Ligne de trajet et Marqueur de position actuelle
    let polyline = L.polyline([], {color: 'red', weight: 5}).addTo(map);
    let marker = L.marker([0, 0]).addTo(map);

    // 3. Fonction de mise à jour
    function updatePosition(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        const newPoint = [lat, lng];

        // On n'ajoute le point que s'il est différent du dernier (évite les sauts)
        if (routeData.length === 0 || routeData[routeData.length - 1][0] !== lat) {
            routeData.push(newPoint);
            polyline.setLatLngs(routeData);
            document.getElementById('count').innerText = routeData.length;
        }

        // Déplacer le marqueur et centrer
        marker.setLatLng(newPoint);
        document.getElementById('status').innerText = "Signal OK";
        document.getElementById('status').style.color = "green";
    }

    // 4. Lancement du GPS
    map.locate({
        setView: true, 
        watch: true, 
        enableHighAccuracy: true,
        timeout: 10000
    });

    map.on('locationfound', updatePosition);

    map.on('locationerror', (e) => {
        console.error(e.message);
        document.getElementById('status').innerText = "Erreur signal (GPS coupé ?)";
        document.getElementById('status').style.color = "red";
    });
</script>

</body>
</html>

