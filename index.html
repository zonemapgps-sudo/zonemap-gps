<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Zone Map - Cloud Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- LIENS OFFICIELS LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- BIBLIOTH√àQUE SUPABASE -->
    <script src="cdn.jsdelivr.net"></script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; background: #1a1a1a; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* √âcran d'accueil Zone Map */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #007bff 0%, #003d7a 100%);
            color: white; z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            transition: opacity 0.5s ease;
        }
        #welcome-screen h1 { font-size: 3.5rem; margin: 0; letter-spacing: -2px; }
        #welcome-screen p { font-size: 1.2rem; opacity: 0.8; margin-bottom: 40px; }

        /* Panneau de contr√¥le */
        .ui-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none; min-width: 150px;
        }

        /* Boutons */
        .btn-start {
            padding: 18px 50px; font-size: 1.1rem; font-weight: bold;
            color: #003d7a; background: white; border: none;
            border-radius: 50px; cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .btn-start:active { transform: scale(0.95); }

        #recenter-btn {
            margin-top:10px; width:100%; padding:8px; border-radius:5px; 
            border:1px solid #ccc; background:white; cursor:pointer; font-weight:bold;
        }
        #recenter-btn.needed { background-color: #ffeb3b !important; border-color: #fbc02d !important; }

        /* Indicateur d'enregistrement */
        #status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .active-gps #status-dot { background-color: #ff0000; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="welcome-screen">
    <h1>Zone Map</h1>
    <p>Traceur GPS en temps r√©el & Cloud</p>
    <button id="btn-action" class="btn-start" onclick="demarrerZoneMap()">COMMENCER</button>
    <div id="load-check" style="margin-top:25px; font-size: 0.8rem; opacity: 0.6;">V√©rification des composants...</div>
</div>

<div class="ui-panel" id="controls">
    <div id="status-line"><span id="status-dot"></span> <span id="status-text" style="font-weight:bold;">Pr√™t</span></div>
    <div style="font-size: 13px; color: #444; margin-top: 8px;">Points Cloud : <span id="count">0</span></div>
    <button id="recenter-btn" onclick="recenterMap()">üìç Recentrer</button>
</div>

<div id="map"></div>

<script>
    // --- CONFIGURATION SUPABASE ---
    const SUPABASE_URL = 'https://unwzavmahixfwyplhcxw.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVud3phdm1haGl4Znd5cGxoY3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NjA0NzYsImV4cCI6MjA4MjEzNjQ3Nn0.I4YtMgaIKt17UGr3EfGf0L186GQSlv2puF_EzabP1B0';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    var map, route = [], polyline, marker;
    var autoCenter = true;
    var currentPos = null;
    const sessionID = "session_" + Date.now();

    // 1. Initialisation au chargement
    window.onload = function() {
        if (typeof L !== 'undefined' && typeof supabase !== 'undefined') {
            document.getElementById('load-check').innerHTML = "Syst√®me op√©rationnel ‚úÖ";
            setupMap();
            nettoyerVieuxTrajets(); // Nettoie les donn√©es de + de 7 jours au d√©marrage
        } else {
            document.getElementById('load-check').innerHTML = "Erreur : Composants manquants ‚ùå";
        }
    };

    function setupMap() {
        map = L.map('map', { zoomControl: false }).setView([46.6, 2.2], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }).addTo(map);
        polyline = L.polyline([], {color: '#ff3b30', weight: 6, opacity: 0.8}).addTo(map);
        marker = L.circleMarker([0, 0], { radius: 8, color: '#007aff', fillColor: 'white', fillOpacity: 1, weight: 3 }).addTo(map);

        // D√©tecter si l'utilisateur bouge la carte manuellement
        map.on('movestart', function () {
            autoCenter = false;
            document.getElementById('recenter-btn').classList.add('needed');
        });
    }

    async function nettoyerVieuxTrajets() {
        const uneSemaineAvant = new Date();
        uneSemaineAvant.setDate(uneSemaineAvant.getDate() - 7);
        await _supabase.from('trajets').delete().lt('created_at', uneSemaineAvant.toISOString());
    }

    async function sauvegarderPoint(lat, lng) {
        const { error } = await _supabase
            .from('trajets')
            .insert([{ latitude: lat, longitude: lng, session_id: sessionID }]);
        if (error) console.error("Erreur Cloud:", error.message);
    }

    function recenterMap() {
        autoCenter = true;
        document.getElementById('recenter-btn').classList.remove('needed');
        if (currentPos) map.setView(currentPos, 17);
    }

    function demarrerZoneMap() {
        if (!map) return;
        document.getElementById('welcome-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
        }, 500);

        map.locate({ watch: true, enableHighAccuracy: true });

        map.on('locationfound', function(e) {
            document.getElementById('controls').classList.add('active-gps');
            document.getElementById('status-text').innerHTML = "En direct";
            
            currentPos = e.latlng;
            route.push(currentPos);
            polyline.setLatLngs(route);
            marker.setLatLng(currentPos);
            document.getElementById('count').innerHTML = route.length;
            
            if (autoCenter) map.setView(currentPos, 17);

            // Envoi au Cloud Supabase
            sauvegarderPoint(currentPos.lat, currentPos.lng);
        });

        map.on('locationerror', function(e) {
            document.getElementById('status-text').innerHTML = "Erreur signal";
        });
    }
</script>

</body>
</html>
