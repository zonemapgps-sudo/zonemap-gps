<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Zone Map 2025</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- LIENS LEAFLET (Cartographie) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- LIEN SUPABASE (Base de donn√©es) -->
    <script src="unpkg.com"></script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; background: #1a1a1a; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; z-index: 1; background: #222; }
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #007bff 0%, #003d7a 100%);
            color: white; z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .ui-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 12px; display: none;
        }
        .btn-start { padding: 18px 50px; font-size: 1.1rem; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; background: white; color: #003d7a; }
        #recenter-btn { margin-top:10px; width:100%; padding:8px; border-radius:5px; border:1px solid #ccc; background:white; cursor:pointer; font-weight:bold;}
        #status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .active-gps #status-dot { background-color: #ff0000; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="welcome-screen">
    <h1>Zone Map</h1>
    <p>Traceur Cloud & Local</p>
    <button id="btn-action" class="btn-start" onclick="demarrerZoneMap()">COMMENCER</button>
    <div id="load-check" style="margin-top:25px; font-size: 0.8rem; opacity: 0.6;">Initialisation...</div>
</div>

<div class="ui-panel" id="controls">
    <div id="status-line"><span id="status-dot"></span> <span id="status-text">Pr√™t</span></div>
    <div style="font-size: 13px; color: #444; margin-top: 8px;">Points : <span id="count">0</span></div>
    <button id="recenter-btn" onclick="recenterMap()">üìç Recentrer</button>
</div>

<div id="map"></div>

<script>
    // --- CONFIGURATION ---
   const SUPABASE_URL = 'https://unwzavmahixfwyplhcxw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVud3phdm1haGl4Znd5cGxoY3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NjA0NzYsImV4cCI6MjA4MjEzNjQ3Nn0.I4YtMgaIKt17UGr3EfGf0L186GQSlv2puF_EzabP1B0';
    
    var _supabase, map, route = [], polyline, marker;
    var autoCenter = true;
    var currentPos = null;
    const sessionID = "session_" + Date.now();

    // --- INITIALISATION ---
    window.onload = function() {
        // 1. On initialise la carte IMM√âDIATEMENT (√©vite l'√©cran noir)
        setupMap();

        // 2. On tente de charger Supabase apr√®s 1 seconde
        setTimeout(function() {
            try {
                if (typeof supabase !== 'undefined') {
                    _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    document.getElementById('load-check').innerHTML = "Syst√®me Cloud Pr√™t ‚úÖ";
                    nettoyerVieuxTrajets();
                } else {
                    document.getElementById('load-check').innerHTML = "Mode Local (Cloud non charg√©) ‚ö†Ô∏è";
                }
            } catch (err) {
                document.getElementById('load-check').innerHTML = "Erreur Cloud : " + err.message;
            }
        }, 1000);
    };

    function setupMap() {
        try {
            map = L.map('map', { zoomControl: false }).setView([46.6, 2.2], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                attribution: '¬© OSM',
                maxZoom: 19
            }).addTo(map);
            
            polyline = L.polyline([], {color: '#ff3b30', weight: 6}).addTo(map);
            marker = L.circleMarker([0,0], { radius: 8, color: '#007aff', fillColor: 'white', fillOpacity: 1, weight: 3 }).addTo(map);

            map.on('movestart', function () {
                autoCenter = false;
                document.getElementById('recenter-btn').style.background = "#ffeb3b";
            });
        } catch (e) {
            console.error("Erreur Map:", e);
        }
    }

    async function sauvegarderPoint(lat, lng) {
        if (!_supabase) return; // Si Supabase n'est pas charg√©, on ignore
        const { error } = await _supabase.from('trajets').insert([{ latitude: lat, longitude: lng, session_id: sessionID }]);
    }

    async function nettoyerVieuxTrajets() {
        if (!_supabase) return;
        const uneSemaineAvant = new Date();
        uneSemaineAvant.setDate(uneSemaineAvant.getDate() - 7);
        await _supabase.from('trajets').delete().lt('created_at', uneSemaineAvant.toISOString());
    }

    function recenterMap() {
        autoCenter = true;
        document.getElementById('recenter-btn').style.background = "white";
        if (currentPos) map.setView(currentPos, 17);
    }

    function demarrerZoneMap() {
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('controls').style.display = 'block';

        map.locate({ watch: true, enableHighAccuracy: true });

        map.on('locationfound', function(e) {
            document.getElementById('controls').classList.add('active-gps');
            document.getElementById('status-text').innerHTML = "En direct";
            currentPos = e.latlng;
            route.push(currentPos);
            polyline.setLatLngs(route);
            marker.setLatLng(currentPos);
            document.getElementById('count').innerHTML = route.length;
            if (autoCenter) map.setView(currentPos, 17);
            
            // Tentative de sauvegarde Cloud
            sauvegarderPoint(currentPos.lat, currentPos.lng);
        });
    }
</script>

</body>
</html>
