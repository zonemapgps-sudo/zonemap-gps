<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Zone Map - Traceur GPS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- LIENS OFFICIELS LEAFLET -->
    <link rel="stylesheet" href="unpkg.com" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="unpkg.com" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; background: #1a1a1a; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* Écran d'accueil Zone Map */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #007bff 0%, #003d7a 100%);
            color: white; z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            transition: opacity 0.5s ease;
        }
        #welcome-screen h1 { font-size: 3.5rem; margin: 0; letter-spacing: -2px; }
        #welcome-screen p { font-size: 1.2rem; opacity: 0.8; margin-bottom: 40px; }

        /* Panneau de contrôle */
        .ui-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none; min-width: 150px;
        }

        /* Bouton Commencer */
        .btn-start {
            padding: 18px 50px; font-size: 1.1rem; font-weight: bold;
            color: #003d7a; background: white; border: none;
            border-radius: 50px; cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .btn-start:active { transform: scale(0.95); }

        /* Indicateur d'enregistrement */
        #status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .active-gps #status-dot { background-color: #ff0000; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="welcome-screen">
    <h1>Zone Map</h1>
    <p>Traceur GPS en temps réel</p>
    <button id="btn-action" class="btn-start" onclick="demarrerZoneMap()">COMMENCER</button>
    <div id="load-check" style="margin-top:25px; font-size: 0.8rem; opacity: 0.6;">Vérification des composants...</div>
</div>

<div class="ui-panel" id="controls">
    <div id="status-line"><span id="status-dot"></span> <span id="status-text" style="font-weight:bold;">Prêt</span></div>
    <div style="font-size: 13px; color: #444; margin-top: 8px;">Points : <span id="count">0</span></div>
</div>

<div id="map"></div>

<script>
    var map, route = [], polyline, marker;

    // 1. Initialisation au chargement
    window.onload = function() {
        if (typeof L !== 'undefined') {
            document.getElementById('load-check').innerHTML = "Système opérationnel ✅";
            setupMap();
        } else {
            document.getElementById('load-check').innerHTML = "Erreur : Bibliothèques Leaflet introuvables ❌";
            document.getElementById('btn-action').style.display = "none";
        }
    };

    function setupMap() {
        // Création de la carte
        map = L.map('map', { zoomControl: false }).setView([46.6, 2.2], 5);
        
        // Ajout des tuiles (fond de carte)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            attribution: '© OSM' 
        }).addTo(map);
        
        // Initialisation de la ligne de trajet
        polyline = L.polyline([], {color: '#ff3b30', weight: 6, opacity: 0.8}).addTo(map);
        
        // Initialisation du marqueur sur une position par défaut (sera déplacé par le GPS)
        marker = L.circleMarker([0, 0], {
            radius: 8, 
            color: '#007aff', 
            fillColor: 'white', 
            fillOpacity: 1, 
            weight: 3
        }).addTo(map);
    }

    function demarrerZoneMap() {
        if (!map) return;

        // Transition visuelle
        document.getElementById('welcome-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
        }, 500);

        // Lancement du traçage
        document.getElementById('status-text').innerHTML = "Recherche GPS...";
        
        map.locate({
            watch: true,
            enableHighAccuracy: true,
            timeout: 60000
        });

        map.on('locationfound', function(e) {
            document.getElementById('controls').classList.add('active-gps');
            document.getElementById('status-text').innerHTML = "Enregistrement";
            
            var latlng = e.latlng;
            route.push(latlng);
            
            // Mise à jour du tracé et du marqueur
            polyline.setLatLngs(route);
            marker.setLatLng(latlng);
            
            // Mise à jour de l'affichage
            document.getElementById('count').innerHTML = route.length;
            
            // On centre la carte sur l'utilisateur
            map.setView(latlng, 17);
        });

        map.on('locationerror', function(e) {
            document.getElementById('status-text').innerHTML = "Erreur signal";
            console.error("Erreur GPS : " + e.message);
        });
    }
</script>

</body>
</html>
